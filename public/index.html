<!-- Google Identity -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
<div id="g_id_signin" style="margin:12px 0"></div>

<script>
(function () {
  // Your OAuth Web Client ID
  const WEB_CLIENT_ID =
    '468716163323-st1b43fu76emqlj1cde6mmq770sbeno1.apps.googleusercontent.com';

  // --- tiny helper for POSTing JSON and being strict about JSON responses ---
  async function apiPost(path, body) {
    const r = await fetch(path, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    const ct = r.headers.get('content-type') || '';
    const text = await r.text();
    if (!ct.includes('application/json')) {
      throw new Error(`Non-JSON from ${path}: ${r.status} ${text.slice(0,120)}`);
    }
    const j = JSON.parse(text);
    if (!r.ok || j.error) throw new Error(j.error || `HTTP ${r.status}`);
    return j;
  }

  // Called after Google signs the user in
  async function afterSignIn(idToken) {
    // === #1: make the id token available to the whole SPA (Documents uses this) ===
    window.__idToken = idToken;

    // Load Transactions (keep your existing renderer if present)
    try {
      // use the Hosting rewrite to Cloud Run; either /api/get-portal-data or /get-portal-data is fine
      const data = await apiPost('/api/get-portal-data', { idToken });
      // hand off to whatever you already use to render transactions
      if (typeof renderTransactions === 'function') {
        renderTransactions(data.tx || []);
      } else {
        // fallback: stash so your existing code can read it
        window.__tx = data.tx || [];
        document.dispatchEvent(new CustomEvent('tx:update', { detail: window.__tx }));
      }
    } catch (e) {
      console.error('[init] load transactions failed:', e);
    }

    // If user is on the Documents view, load that too (the SPA docs script defines listDocs)
    try {
      if (location.hash === '#/documents' && typeof listDocs === 'function') {
        await listDocs(); // will POST /api/list-docs with window.__idToken
      }
    } catch (e) {
      console.error('[init] listDocs failed:', e);
    }
  }

  // Initialize Google Identity on page load and render a button if you have a container
  window.addEventListener('load', () => {
    if (!window.google || !google.accounts || !google.accounts.id) return;

    google.accounts.id.initialize({
      client_id: WEB_CLIENT_ID,
      callback: (resp) => afterSignIn(resp.credential),
      auto_select: true,
      cancel_on_tap_outside: false
    });

    const btn = document.getElementById('g_id_signin');
    if (btn) {
      google.accounts.id.renderButton(btn, { theme: 'outline', size: 'large' });
    }
  });
})();
</script>

