<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GP Member Portal</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --bg:#f8fafc; --ink:#111827; --ink2:#374151; --ink3:#4b5563; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fff;color:var(--ink)}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);position:sticky;top:0;background:#fff;z-index:10}
    .brand{font-weight:600}
    nav a{margin-left:12px;text-decoration:none;color:var(--ink2);padding:6px 10px;border-radius:8px}
    nav a.active{background:var(--bg);border:1px solid var(--border)}
    #g_id_signin{margin-left:8px}
    .status{font-size:12px;color:var(--muted);margin-left:6px}
    main{max-width:1100px;margin:18px auto;padding:0 18px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.03);overflow:hidden}
    .hd{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .bd{padding:16px}
    .kpis{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .kpi{flex:1 1 240px;border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff}
    .kpi .t{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kpi .v{font-size:20px;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;font-size:14px}
    th{background:#f6f7fb;font-weight:600}
    .group{background:#fafafa}
    .group td{font-weight:600}
    .grand{background:#f0f7f0}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    button{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--bg);cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="brand">GP Member Portal</div>
    <nav>
      <a href="#/transactions" id="nav-transactions" class="active">Transactions</a>
      <a href="#/documents" id="nav-documents">Documents</a>
      <span class="status" id="status">Loading…</span>
      <div id="g_id_signin"></div>
    </nav>
  </header>

  <main>
    <!-- Transactions -->
    <section id="view-transactions" class="card">
      <div class="hd"><div>Transactions</div></div>
      <div class="bd">
        <div class="kpis">
          <div class="kpi">
            <div class="t">Member</div>
            <div class="v" id="kpi-name">—</div>
            <div class="muted" id="kpi-email" style="font-size:12px;margin-top:4px">—</div>
          </div>
          <div class="kpi">
            <div class="t">Total Balance</div>
            <div class="v" id="kpi-total">$0</div>
            <div class="muted" style="font-size:12px;margin-top:4px" id="kpi-rows">— rows</div>
          </div>
        </div>

        <div id="tx-empty" class="muted">No transactions found.</div>
        <div id="tx-wrap" class="hidden">
          <table>
            <thead id="tx-thead"></thead>
            <tbody id="tx-tbody"></tbody>
            <tfoot id="tx-tfoot"></tfoot>
          </table>
        </div>
      </div>
    </section>

    <!-- Documents -->
    <section id="view-documents" class="card hidden">
      <div class="hd">
        <div>Documents</div>
        <a href="#/transactions" class="muted" style="font-size:12px;text-decoration:none;">← Back to Transactions</a>
      </div>
      <div class="bd">
        <div id="docs-empty" class="muted">No documents available.</div>
        <div id="docs-wrap" class="hidden">
          <table>
            <thead>
              <tr>
                <th>Title</th>
                <th>Member</th>
                <th>Modified</th>
                <th class="right">Size</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="docs-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- GIS -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
  (function(){
    // ===== CONFIG: tweak only if your column names are different =====
    const GROUP_KEY_CANDIDATES = ['Entity','Fund','Vehicle','Partnership','Issuer','Company','Investment'];
    const AMOUNT_COL_CANDIDATES = ['Amount','Net Amount','Net_Amount','Amount_USD','Balance','Balance_USD','NetBalance','Net'];
    const MEMBER_NAME_COLS = ['Member_Name','MemberName','Name'];
    const MEMBER_EMAIL_COLS = ['Member_Email','MemberEmail','Email','User_Email'];
    const CURRENCY = 'USD';
    // =================================================================

    const WEB_CLIENT_ID = '468716163323-st1b43fu76emqlj1cde6mmq770sbeno1.apps.googleusercontent.com';
    const CACHE_KEY = 'gp:idtoken';
    const nf = new Intl.NumberFormat('en-US', { style:'currency', currency:CURRENCY, maximumFractionDigits:2 });

    const statusEl = document.getElementById('status');
    function setStatus(s){ statusEl.textContent = s; }

    // ---- Token cache (no re-login on refresh) ----
    function decodeJwt(token){
      try{const p=token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(decodeURIComponent(escape(atob(p))));}catch(_){return {}}
    }
    function cacheToken(idToken){
      const p=decodeJwt(idToken); localStorage.setItem(CACHE_KEY, JSON.stringify({t:idToken, expMs:(p.exp||0)*1000, name:p.name||'', email:p.email||''}));
      return idToken;
    }
    function getCached(){ try{const o=JSON.parse(localStorage.getItem(CACHE_KEY)||''); if(!o||!o.t||!o.expMs) return null; if(Date.now()<o.expMs-15000) return o; return null;}catch(_){return null}}

    // ---- strict JSON POST ----
    async function apiPost(path, body){
      const r = await fetch(path, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const ct = r.headers.get('content-type')||''; const text = await r.text();
      if(!ct.includes('application/json')) throw new Error(`Non-JSON from ${path}: ${r.status} ${text.slice(0,120)}`);
      const j = JSON.parse(text); if(!r.ok || j.error) throw new Error(j.error || `HTTP ${r.status}`); return j;
    }

    // ---- Helpers for table rendering ----
    const num = v => {
      if (v==null) return 0;
      const s = String(v).replace(/[\$,]/g,'').trim();
      const x = Number(s); return isFinite(x) ? x : 0;
    };
    const firstExistingKey = (row, candidates) => candidates.find(k => k in row) || null;

    // Pick a group key column present in most rows
    function chooseGroupKey(rows){
      for(const k of GROUP_KEY_CANDIDATES){ if(rows.some(r => r[k])) return k; }
      return GROUP_KEY_CANDIDATES[0];
    }
    // Pick an amount column with meaningful totals
    function chooseAmountCol(rows){
      // prefer explicit names first
      for(const k of AMOUNT_COL_CANDIDATES){ const tot = rows.reduce((a,r)=>a+num(r[k]),0); if (Math.abs(tot) > 0) return k; }
      // fallback: first numeric-looking column
      const keys = Object.keys(rows[0]||{});
      for(const k of keys){ const tot = rows.reduce((a,r)=>a+num(r[k]),0); if (Math.abs(tot) > 0) return k; }
      return null;
    }

    function fmtDate(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)?'':d.toLocaleDateString(); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // ================= TRANSACTIONS =================
    function renderTransactions(rows, profile){
      // KPIs
      document.getElementById('kpi-name').textContent  = profile.name || '—';
      document.getElementById('kpi-email').textContent = profile.email || '—';

      const wrap  = document.getElementById('tx-wrap');
      const empty = document.getElementById('tx-empty');
      const thead = document.getElementById('tx-thead');
      const tbody = document.getElementById('tx-tbody');
      const tfoot = document.getElementById('tx-tfoot');

      if (!rows || !rows.length){
        wrap.classList.add('hidden'); empty.classList.remove('hidden');
        document.getElementById('kpi-total').textContent = nf.format(0);
        document.getElementById('kpi-rows').textContent  = '0 rows';
        return;
      }

      // Choose keys
      const groupKey = chooseGroupKey(rows);
      const amtKey   = chooseAmountCol(rows) || 'Amount';

      // Build header (preserve main columns + amount on the right)
      const cols = Object.keys(rows[0]).filter(k => k !== amtKey);
      thead.innerHTML = `<tr>${cols.map(c=>`<th>${esc(c)}</th>`).join('')}<th class="right">${esc(amtKey)}</th></tr>`;

      // Group rows
      const groups = new Map();
      for (const r of rows){
        const g = r[groupKey] || 'Other';
        if (!groups.has(g)) groups.set(g, []);
        groups.get(g).push(r);
      }

      // Render body with group subtotals
      let grand = 0;
      let bodyHtml = '';
      for (const [gName, list] of groups.entries()){
        const subtotal = list.reduce((a,r)=>a+num(r[amtKey]),0);
        grand += subtotal;
        bodyHtml += `<tr class="group"><td colspan="${cols.length}">${esc(gName)}</td><td class="right">${nf.format(subtotal)}</td></tr>`;
        for (const r of list){
          bodyHtml += `<tr>` +
              cols.map(c => `<td>${esc(r[c])}</td>`).join('') +
              `<td class="right">${nf.format(num(r[amtKey]))}</td>` +
            `</tr>`;
        }
      }
      tbody.innerHTML = bodyHtml;

      // Grand total
      tfoot.innerHTML = `<tr class="grand"><td colspan="${cols.length}"><b>Grand Total</b></td><td class="right"><b>${nf.format(grand)}</b></td></tr>`;

      // KPIs
      document.getElementById('kpi-total').textContent = nf.format(grand);
      document.getElementById('kpi-rows').textContent  = `${rows.length} rows`;

      empty.classList.add('hidden'); wrap.classList.remove('hidden');
    }

    // ================= DOCUMENTS =================
    async function listDocs(){
      if (!window.__idToken) return;
      const { docs } = await apiPost('/api/list-docs', { idToken: window.__idToken });
      const wrap = document.getElementById('docs-wrap');
      const empty = document.getElementById('docs-empty');
      const tbody = document.getElementById('docs-tbody');

      if (!docs || !docs.length){
        wrap.classList.add('hidden'); empty.classList.remove('hidden'); return;
      }
      tbody.innerHTML = docs.map(r => `
        <tr>
          <td>${esc(r.Doc_Title || '')}</td>
          <td>${esc(r.Member_Name || '')}</td>
          <td>${esc(r.ModifiedTime ? fmtDate(r.ModifiedTime) : '')}</td>
          <td class="right">${r.SizeBytes ? esc(Number(r.SizeBytes).toLocaleString()) : ''}</td>
          <td><button class="doc-dl" data-fid="${esc(r.GoogleFileID)}">Download</button></td>
        </tr>
      `).join('');

      empty.classList.add('hidden'); wrap.classList.remove('hidden');
    }
    async function downloadDoc(fileId, btn){
      try{
        btn.disabled=true; const old=btn.textContent; btn.textContent='Preparing…';
        const { token } = await apiPost('/api/mint-doc', { idToken: window.__idToken, fileId });
        location.href = `/api/dl?token=${encodeURIComponent(token)}`;
        btn.textContent=old; btn.disabled=false;
      }catch(e){ console.error(e); alert('Unable to download this file.'); btn.disabled=false; btn.textContent='Download'; }
    }
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.doc-dl'); if (btn) downloadDoc(btn.getAttribute('data-fid'), btn);
    });

    // ================= ROUTER =================
    function setActiveNav(){
      const isDocs = location.hash === '#/documents';
      document.getElementById('nav-transactions').classList.toggle('active', !isDocs);
      document.getElementById('nav-documents').classList.toggle('active', isDocs);
    }
    function showView(hash){
      const isDocs = hash === '#/documents';
      document.getElementById('view-transactions').classList.toggle('hidden', isDocs);
      document.getElementById('view-documents').classList.toggle('hidden', !isDocs);
      setActiveNav();
      if (isDocs) listDocs();
    }
    window.addEventListener('hashchange', () => showView(location.hash));

    // ================= SIGN-IN / BOOT =================
    async function afterSignIn(idToken){
      const p = decodeJwt(idToken);
      window.__idToken = cacheToken(idToken); // store + expose

      setStatus('Loading transactions…');
      try{
        const data = await apiPost('/api/get-portal-data', { idToken });
        // Try to pick member name/email from rows if present; fallback to token
        const sample = (data.tx && data.tx[0]) || {};
        const nameKey  = firstExistingKey(sample, MEMBER_NAME_COLS);
        const emailKey = firstExistingKey(sample, MEMBER_EMAIL_COLS);
        const profile = {
          name:  sample[nameKey]  || p.name  || '',
          email: sample[emailKey] || p.email || ''
        };
        renderTransactions(data.tx || [], profile);
        setStatus('Ready.');
        if (location.hash === '#/documents') listDocs();
      }catch(e){
        console.error(e); setStatus('Failed to load.');
      }
    }

    function initGis(){
      if(!window.google || !google.accounts || !google.accounts.id){ setTimeout(initGis,50); return; }
      google.accounts.id.initialize({
        client_id: WEB_CLIENT_ID,
        callback: (resp)=>afterSignIn(resp.credential),
        auto_select: true,
        use_fedcm_for_prompt: true,
        cancel_on_tap_outside: false
      });
      const btn = document.getElementById('g_id_signin');
      if (btn) google.accounts.id.renderButton(btn, { theme:'outline', size:'large' });
      google.accounts.id.prompt(); // silent reuse if possible
    }

    function boot(){
      if (!location.hash) location.replace('#/transactions');
      showView(location.hash);

      const cached = getCached();
      if (cached){ window.__idToken = cached.t; document.getElementById('kpi-name').textContent = cached.name||'—'; document.getElementById('kpi-email').textContent = cached.email||'—'; afterSignIn(cached.t); }
      initGis();
    }

    window.addEventListener('load', boot);
  })();
  </script>
</body>
</html>
