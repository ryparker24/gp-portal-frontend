<!doctype html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#1E2B45">
  <meta property="og:title" content="Allegis Portal">
  <meta property="og:description" content="Member transactions & documents">
  <meta property="og:image" content="https://portal.allegiscapital.com/og-card.png">
  <meta property="og:url" content="https://portal.allegiscapital.com">
  <style>
    :root { --navy:#1E2B45; --red:#E94B3C; --muted:#f5f7fb; --ink:#222; --border:#e8edf7; --sidebar:#ffffff; }
    * { box-sizing: border-box; }
    body { font-family: Roboto, sans-serif; margin:0; background:var(--muted); color:var(--ink); }

    /* KPI sub-rows */
    .kpi-rows{ font-size:16px; line-height:1.75; }
    .kpi-rows div{ margin-top:2px; }
    .kpi-rows a{ color:inherit; text-decoration:underline; cursor:pointer; }

    /* ===== Layout ===== */
    .app { display:grid; grid-template-columns: 240px 1fr; min-height:100vh; }
    .sidebar { background:var(--sidebar); border-right:1px solid var(--border); padding:16px 14px; position:sticky; top:0; height:100vh; overflow:auto; }
    .content { padding: 16px 24px 24px 12px; }
    .wrap { max-width:1100px; margin:0; }
    .sidebar .brand-row { margin-bottom: 44px; }

    /* ===== Header ===== */
    .brand-block { margin-bottom: 8px; }
    .brand-row { display:flex; align-items:center; gap:12px; }
    .brand-row img { height:56px; }
    .title-row { display:flex; align-items:flex-start; gap:12px; margin-top:8px; }
    .title { font-size:28px; font-weight:700; color:var(--navy); }
    .sub { color:#666; font-size:12px; }

    /* ===== Top right status/controls ===== */
    .topbar { margin-left:auto; display:flex; align-items:flex-start; gap:8px; position:relative; }
    .statusline { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    #status { color:#b00; min-height:16px; }
    .kpi:empty { display:none; }

    /* ===== Impersonation ===== */
    .imp { position:relative; }
    .imp-btn { background:#fff; border:1px solid #ccd6ee; border-radius:8px; padding:6px 10px; cursor:pointer; font-size:12px; }
    .imp-panel { position:absolute; right:0; top:36px; z-index:10; background:#fff; border:1px solid #ccd6ee; border-radius:10px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,.12); width:520px; }
    .imp-panel.hidden { display:none; }
    .imp-row { display:flex; gap:8px; flex-wrap:wrap; }
    .imp-panel input { padding:6px 8px; border:1px solid #dde3f5; border-radius:8px; min-width:160px; font-size:12px; }
    .imp-panel button { padding:6px 10px; border:1px solid #dde3f5; border-radius:8px; background:#f5f7fb; cursor:pointer; font-size:12px; }
    .imp-state { margin-left:8px; font-size:12px; color:#666; }

    /* ===== Sidebar nav ===== */
    .nav { display:flex; flex-direction:column; gap:6px; }
    .nav a { display:block; padding:10px 12px; border-radius:10px; text-decoration:none; color:#2a4b8d; font-weight:500; }
    .nav a.active { background:#eef3ff; text-decoration:none; }

    /* ===== Cards & grid ===== */
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 1px 6px rgba(0,0,0,.08); padding:16px; }
    .kpi { font-size:28px; font-weight:700; }

    /* ===== Tables ===== */
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px 8px; border-bottom:1px solid #eee; vertical-align:top; }
    th { text-align:left; font-size:12px; color:#666; }
    td.num { text-align:right; white-space:nowrap; }
    tr.entity-hdr td { background:#f5f7fb; font-weight:700; border-top:2px solid var(--border); }
    tr.subtotal td { font-weight:700; border-top:2px solid var(--border); }
    tr.grand td { font-weight:800; border-top:3px solid #dbe4f3; }

    .hidden { display:none !important; }

    /* ===== Wire cards ===== */
    .bank-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:8px;
      max-width: 760px;
    }
    .bank-card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 6px rgba(0,0,0,.06); }
    .bank-card h4{ margin:0 0 6px 0; }
    .rows-wrap{ display:grid; row-gap:2px; }
    .rows{ display:flex; align-items:baseline; gap:8px; margin:0; }
    .label{ white-space:nowrap; font-size:12px; color:#666; }
    .label::after{ content: ":"; margin-left:2px; }
    .value{
      flex:1 1 auto; min-width:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:13px; line-height:1.35;
      overflow-wrap:anywhere; word-break:break-word;
    }
    .buttons{ flex:0 0 auto; display:flex; gap:6px; margin:0; }
    .btn{ padding:2px 6px; font-size:11px; border:1px solid #dde3f5; background:#f5f7fb; border-radius:8px; cursor:pointer; }
    .muted { color:#888; }

    /* ===== Documents: two-level tree ===== */
    .doc-layout { display:grid; grid-template-columns: 320px 1fr; gap:12px; }
    .doc-files { background:#fff; border-radius:14px; box-shadow:0 1px 6px rgba(0,0,0,.08); }
    .doc-files { padding:0; border:1px solid var(--border); overflow:auto; }

    .files-head { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eef2fb; }
    .files-title { font-size:14px; font-weight:700; color:#2a4b8d; }
    .crumbs { font-size:12px; color:#666; }
    .file-table { width:100%; border-collapse:collapse; }
    .file-table th, .file-table td { padding:10px 12px; border-bottom:1px solid #f1f4fb; }
    .file-table th { font-size:12px; color:#666; text-align:left; }
    .file-table td.num { text-align:right; white-space:nowrap; }
    .file-actions { display:flex; gap:8px; justify-content:flex-end; }
    .link { color:#2a4b8d; text-decoration:underline; cursor:pointer; font-size:12px; }

    @media (max-width: 1100px){
      .doc-layout { grid-template-columns: 1fr; }
    }

    /* Responsive */
    @media (max-width: 920px){
      .app { grid-template-columns: 1fr; }
      .sidebar { position:relative; height:auto; border-right:none; border-bottom:1px solid var(--border); }
      .grid { grid-template-columns: 1fr; }
      .bank-grid { grid-template-columns: 1fr; }
      .imp-panel { width:calc(100vw - 32px); right:0; }
    }
    tr.final-total td {
      font-weight: 800 !important;
      border-top: 4px solid #000;
    }
        /* Folder pane matches sidebar look */
    #folder-pane .nav-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
      padding: 0;
    }
    
/* Make folder rows match the left nav look */
    #folder-pane .nav-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 10px;
      color: #2a4b8d;
      font-weight: 500;
      font-size: 1.1rem;  /* ðŸ‘ˆ bump this up (try 1rem, 1.05rem, or 1.1rem) */
    }
    #folder-pane .nav-item:hover { background: #f6f9ff; }
    #folder-pane .nav-item.active { background: #eef3ff; }
    
        
    /* badge count pill */
    #folder-pane .nav-item .badge {
      font-size: 14px;
      line-height: 1;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--muted);
      color: var(--ink);
      opacity: .85;
    }
    
    #folder-pane .nav-item.active .badge {
      background: rgba(255,255,255,.2);
      color: #fff;
      opacity: 1;
    }
  .card-header {
    font-weight: 700;
    font-size: 13px;
    color: #2a4b8d;
    padding: 10px 12px;
    border-bottom: 1px solid #eef2fb;
  }
  </style>
</head>
<body>
  <div class="app">
    <!-- ===== Left Sidebar ===== -->
    <aside class="sidebar">
      <div class="brand-block">
        <div class="brand-row"><img src="/assets/allegis-logo.svg" alt="Allegis Capital"></div>
      </div>

      <nav class="nav">
        <a href="#/interests"     id="linkInterests">GP Interests</a>
        <a href="#/transactions"  id="linkTx" class="active">Member Outstanding Balance</a>
        <a href="#/documents"     id="linkDocs">Documents</a>
        <a href="#/wire"          id="linkWire">Wire Instructions</a>
      </nav>
    </aside>

    <!-- ===== Main Content ===== -->
    <main class="content">
      <div class="wrap">
        <!-- Title + controls -->
        <div class="title-row">
          <div>
            <div class="title" id="appTitle">GP Member Portal</div>
            <div class="sub"   id="buildTag">Build: â€”</div>
          </div>
          <div class="topbar">
            <div class="statusline">
              <span id="signedAs" class="sub">Signed out</span>
              <span id="g_id_signin"></span>
            </div>

            <!-- Impersonation in the TOPBAR -->
            <div class="imp">
              <button id="imp-toggle" class="imp-btn">Impersonate</button>
              <div id="imp-panel" class="imp-panel hidden">
                <div class="imp-row">
                  <input id="imp-email"  type="email"    placeholder="Act as email (user@domain.com)" />
                  <input id="imp-reason" type="text"     placeholder="Reason (optional)" />
                  <input id="imp-token"  type="password" placeholder="Admin token" />
                </div>
                <div class="imp-row" style="margin-top:8px;">
                  <button id="imp-start">Start</button>
                  <button id="imp-stop">Stop</button>
                  <span id="imp-state" class="imp-state"></span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="status" class="sub" style="margin-top:6px;"></div>

        <!-- KPIs -->
        <div class="grid" style="margin-top:12px;">
          <div class="card">
            <div class="sub">Member</div>
            <div id="kpi-name" class="kpi">â€”</div>
            <div id="kpi-email" class="sub" style="margin-top:4px;">â€”</div>
          </div>
          <div class="card">
            <div class="sub" id="kpi-right-title">Current Balance</div>
            <div id="kpi-right-value" class="kpi"></div>
            <div id="kpi-right-sub" class="sub" style="margin-top:4px;">â€”</div>
          </div>
        </div>

        <!-- Transactions -->
        <div id="card-tx" class="card" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:16px;">Transactions by Entity</h3>
            <div id="updated" class="sub"></div>
          </div>
          <div style="overflow:auto;">
            <table id="tx">
              <thead>
              <tr>
                <th style="width:110px;">Date</th>
                <th>Description</th>
                <th class="num" style="width:140px;">Net</th>
                <th class="num" style="width:160px;">Running Balance</th>
              </tr>
              </thead>
              <tbody></tbody>
              <tfoot></tfoot>
            </table>
          </div>
        </div>

        <!-- Documents -->
        <div id="card-docs" class="card hidden" style="margin-top:12px;">
          <div class="doc-layout">
            <div id="folder-pane" class="card">
              <div class="card-header">Folders</div>
              <nav id="doc-folders" class="nav-list"></nav>
            </div>
            <div class="doc-files">
              <div class="files-head">
                <div class="files-title" id="filesTitle">Select a folder</div>
                <div class="crumbs" id="crumbs">â€”</div>
              </div>
              <div style="overflow:auto;">
                <table class="file-table">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Member</th>
                      <th style="width:160px;">Modified</th>
                      <th class="num" style="width:120px;">Size</th>
                      <th style="width:140px; text-align:right;">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="filesBody"></tbody>
                  <tfoot id="filesFoot"></tfoot>
                </table>
              </div>
            </div>
          </div>
          <div class="sub" id="docs-updated" style="margin-top:8px;"></div>
        </div>

        <!-- GP Interests -->
        <div id="card-interests" class="card hidden" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:16px;">GP Interests</h3>
            <div id="interests-updated" class="sub"></div>
          </div>
          <div style="overflow:auto; margin-top:6px;">
            <table id="interests-table">
              <thead></thead>
              <tbody></tbody>
              <tfoot></tfoot>
            </table>
          </div>
        </div>

        <!-- Wire Instructions -->
        <div id="card-wire" class="card hidden" style="margin-top:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3 style="margin:0;font-size:16px;">Wire Instructions</h3>
            <div id="wire-updated" class="sub"></div>
          </div>
          <div id="wire-bankwrap" class="bank-grid"></div>
          <div class="sub" style="margin-top:12px;">
            <strong style="color:var(--red);">Security Reminder:</strong>
            Always confirm wire instructions via an out-of-band method (phone or known contact) before sending funds.
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <script>
    // ===== CONFIG =====
    const WEB_CLIENT_ID = '468716163323-st1b43fu76emqlj1cde6mmq770sbeno1.apps.googleusercontent.com';

    // ===== utils =====
    const safe   = s => String(s||'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const asDate = s => new Date(String(s||'').replace(/-/g,'/'));
    const money  = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
    const money0 = n => Number(n||0).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});
    const sleep  = ms => new Promise(res => setTimeout(res, ms));
    function setStatus(msg){ const el=document.getElementById('status'); if(el) el.textContent = msg || ''; }
    function parseMoney(v){
      const raw = String(v ?? '').trim(); if (!raw) return 0;
      const norm = raw.replace(/[\u2212\u2010-\u2015]/g, '-');
      const signProbe = norm.replace(/[^\d.\-()]/g, '');
      const isNeg = /\(.*\)/.test(signProbe) || signProbe.includes('-');
      const mag = Number(signProbe.replace(/[^0-9.]/g, '')) || 0;
      return isNeg ? -mag : mag;
    }
    const canonizeEntityName = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    const EXCLUDED_TOTAL_ENTITIES = new Set([
      'MediaTech Management V, LLC',
      'MediaTech Management IV, LLC',
      'MediaTech Management IV Annex, LLC'
    ].map(canonizeEntityName));
    const excludedForTotals = name => EXCLUDED_TOTAL_ENTITIES.has(canonizeEntityName(name));

    window.addEventListener('error', (e)=>{ console.error(e.error || e.message || e); setStatus('Script error: ' + (e.message || 'See console')); });
    window.addEventListener('unhandledrejection', (e)=>{ console.error('Unhandled promise rejection:', e.reason); setStatus('Error: ' + (e.reason?.message || 'See console')); });

    // ===== admin (impersonation) state =====
    window.__admin = { actAs: null, token: null, reason: '' };
    function adminHeaders(){ return window.__admin?.token ? { 'X-Admin-Token': window.__admin.token } : {}; }
    function adminBody(){ const o={}; if(window.__admin?.actAs){ o.actAs = window.__admin.actAs; if(window.__admin?.reason) o.reason = window.__admin.reason; } return o; }

    // ===== strict JSON POST with cookies =====
    async function apiPost(path, body, extraHeaders){
      const headers = { 'Content-Type':'application/json', ...(extraHeaders||{}) };
      const r = await fetch(path, { method:'POST', headers, credentials:'include', cache:'no-store', body: JSON.stringify(body || {}) });
      const contentType = r.headers.get('content-type') || '';
      const raw = await r.text();
      let j = null;
      if (contentType.includes('application/json')) { try { j = JSON.parse(raw); } catch {} }
      if (!r.ok || (j && j.error)) {
        const msg = (j && (j.error || j.message)) || raw || `HTTP ${r.status}`;
        const err = new Error(msg.trim()); err.status = r.status; err.path = path; throw err;
      }
      return j ?? { ok: true, raw };
    }
    async function me(){ return fetch('/api/me', { credentials:'include', cache:'no-store' }); }

    // ===== session wait (used by GIS callback) =====
    async function waitForSession(timeoutMs = 5000){
      const start = Date.now();
      while (Date.now() - start < timeoutMs){
        const r = await me();
        if (r.ok){ try { return await r.json(); } catch { return { user:null }; } }
        await sleep(150);
      }
      throw new Error('Session not ready');
    }

    // ===== KPI helper =====
    function setCapitalCallsKpi(capitalCalls, memberBalanceOutstanding){
      const contributionsToDate = capitalCalls - memberBalanceOutstanding;
      const kTitle = document.getElementById('kpi-right-title');
      const kValue = document.getElementById('kpi-right-value');
      const kSub   = document.getElementById('kpi-right-sub');
      kTitle.textContent = 'Capital Calls';
      kSub.innerHTML = `
        <div class="kpi-rows">
          <div>Total Capital Calls to Date â€” $${money(capitalCalls)}</div>
          <div><a href="#/transactions">(Less: Member Balance Outstanding) â€” $${money(memberBalanceOutstanding)}</a></div>
          <div><strong>Member Contributions to Date â€” $${money(contributionsToDate)}</strong></div>
        </div>`;
    }

    // ===== render: transactions =====
    function renderTransactions(data){
      if (!data || !Array.isArray(data.tx)) { setStatus('We could not determine your Google account. Make sure you open the link while signed in.'); return; }
      setStatus('');
      function localPickMemberName(rows, fallbackEmail){
        const fields = ['Member_Name','MemberName','Name','Member'];
        for (const f of fields){ const r = rows.find(x => x && x[f] && String(x[f]).trim()); if (r) return String(r[f]).trim(); }
        const q = rows.find(x => x && x.QB_Account && String(x.QB_Account).includes('-'));
        if (q){ const last = String(q.QB_Account).split('-').pop().trim(); if (last && /[A-Za-z]/.test(last)) return last; }
        const local = String(fallbackEmail||'').split('@')[0].replace(/\+.*/,'').replace(/[._]/g,' ');
        return local ? local.replace(/\b\w/g, c => c.toUpperCase()) : 'Member';
      }
      const memberDisplayName = localPickMemberName(data.tx, data.actingAs || data.email);
      const memberEmail       = data.actingAs || data.email || '';

      const rows = data.tx.map(r=>{
        const hasNet = r.Net_Amount != null && String(r.Net_Amount).trim() !== '';
        const netVal = hasNet ? parseMoney(r.Net_Amount) : (parseMoney(r.Credit) - parseMoney(r.Debit));
        return { date: asDate(r.Date), dateText: r.Date || '', desc: r.Description || '', entity: r.EntityName || 'â€”', net: netVal };
      });

      const includedRows  = rows.filter(r => !excludedForTotals(r.entity));
      const includedTotal = includedRows.reduce((a, r) => a + r.net, 0);

      document.getElementById('kpi-right-title').textContent = 'Member Outstanding Balance';
      document.getElementById('kpi-right-value').textContent = money(includedTotal);
      document.getElementById('kpi-right-sub').textContent   = `${rows.length} rows`;

      document.getElementById('kpi-name').textContent   = memberDisplayName || 'â€”';
      document.getElementById('kpi-email').textContent  = memberEmail || 'â€”';
      document.getElementById('updated').textContent    = 'Updated ' + new Date(data.updated).toLocaleString();

      window.__currentBalance = includedTotal;

      const tb = document.querySelector('#tx tbody');
      const tf = document.querySelector('#tx tfoot');
      tb.innerHTML = ''; tf.innerHTML = '';

      const groups = new Map();
      for (const it of rows) { if (!groups.has(it.entity)) groups.set(it.entity, []); groups.get(it.entity).push(it); }
      const entityNames = Array.from(groups.keys()).sort((a,b)=> a.localeCompare(b));

      for (const name of entityNames) {
        const list = groups.get(name).sort((a,b)=> a.date - b.date);
        const eh = document.createElement('tr'); eh.className = 'entity-hdr'; eh.innerHTML = `<td colspan="4">${safe(name)}</td>`; tb.appendChild(eh);
        let running = 0;
        for (const r of list) {
          running += r.net;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${safe(r.dateText)}</td><td>${safe(r.desc)}</td><td class="num">${money(r.net)}</td><td class="num">${money(running)}</td>`;
          tb.appendChild(tr);
        }
        const sub = list.reduce((a, x) => a + x.net, 0);
        const st = document.createElement('tr'); st.className = 'subtotal';
        st.innerHTML = `<td></td><td><strong>Subtotal â€“ ${safe(name)}</strong></td><td class="num"><strong>${money(sub)}</strong></td><td class="num"><strong>${money(running)}</strong></td>`;
        tb.appendChild(st);
      }
      const gt = document.createElement('tr'); gt.className = 'grand';
      gt.innerHTML = `<td></td><td><strong>Grand Total</strong></td><td class="num"><strong>${money(includedTotal)}</strong></td><td class="num"><strong>${money(includedTotal)}</strong></td>`;
      tf.appendChild(gt);

      const signedAs = document.getElementById('signedAs');
      if (signedAs) {
        signedAs.textContent = (data.actingAs && data.actingAs !== data.email)
          ? `Acting as ${data.actingAs} (admin: ${data.email})`
          : `Signed in as ${data.email}`;
      }
    }
function renderFolderList(folders, selectedKey) {
  const host = document.getElementById('doc-folders');
  host.innerHTML = folders.map(f => `
    <a
      href="#"
      class="nav-item ${f.key === selectedKey ? 'active' : ''}"
      data-key="${f.key}"
      aria-current="${f.key === selectedKey ? 'page' : 'false'}"
    >
      <span class="label">${f.label}</span>
      <span class="badge">${f.count ?? 0}</span>
    </a>
  `).join('');

  host.querySelectorAll('.nav-item').forEach(el => {
    el.addEventListener('click', (e) => {
      e.preventDefault();
      const key = el.dataset.key;

      // update highlight
      host.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');

      // load that folderâ€™s docs
      loadFolder(key); 
    });
  });
}
// Called when a folder (Type) is clicked in the left pane
function loadFolder(typeKey){
  const byType = window.__docsByType || new Map();
  const yearsMap = byType.get(typeKey);
  const filesTitle = document.getElementById('filesTitle');
  const crumbs = document.getElementById('crumbs');

  if (!yearsMap){
    filesTitle.textContent = 'Select a folder';
    crumbs.textContent = 'â€”';
    document.getElementById('filesBody').innerHTML = '';
    document.getElementById('filesFoot').innerHTML = '';
    return;
  }

  // Pick newest year for that Type
  const years = Array.from(yearsMap.keys()).sort((a,b)=> b.localeCompare(a));
  const year = years[0];
  const list = yearsMap.get(year) || [];
  showFiles(typeKey, year, list);
}

    // ===== two-level folder helpers for Documents =====
    function groupDocsByTypeYear(docs){
      // Returns: Map<Type, Map<Year, Array<doc>>>
      const byType = new Map();
      for (const d of (docs || [])){
        const type = String(d.Doc_Type || 'Other').trim() || 'Other';
        const year = String(d.Doc_Year || 'Unknown').trim() || 'Unknown';
        if (!byType.has(type)) byType.set(type, new Map());
        const byYear = byType.get(type);
        if (!byYear.has(year)) byYear.set(year, []);
        byYear.get(year).push(d);
      }
      // sort docs within each year by ModifiedTime desc
      for (const [, byYear] of byType){
        for (const [, arr] of byYear){
          arr.sort((a,b)=> (new Date(b.ModifiedTime||0)) - (new Date(a.ModifiedTime||0)));
        }
      }
      return byType;
    }

    function showFiles(type, year, files){
      const title = document.getElementById('filesTitle');
      const crumbs = document.getElementById('crumbs');
      const body = document.getElementById('filesBody');
      const foot = document.getElementById('filesFoot');
      title.textContent = `${type} â€” ${year}`;
      crumbs.textContent = `Documents / ${type} / ${year}`;
      body.innerHTML = '';
      foot.innerHTML = '';

      if (!files || !files.length){
        body.innerHTML = `<tr><td class="sub" colspan="5">No files</td></tr>`;
        return;
      }

      for (const r of files){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${safe(r.Doc_Title || '')}</td>
          <td>${safe(r.Member_Name || '')}</td>
          <td>${r.ModifiedTime ? new Date(r.ModifiedTime).toLocaleString() : ''}</td>
          <td class="num">${r.SizeBytes ? Number(r.SizeBytes).toLocaleString() : ''}</td>
          <td>
            <div class="file-actions">
              ${r.ViewURL ? `<a class="link" href="${safe(r.ViewURL)}" target="_blank" rel="noopener">View</a>` : ''}
              ${r.GoogleFileID ? `<a class="link dl" data-fid="${safe(r.GoogleFileID)}">Download</a>` : ''}
            </div>
          </td>
        `;
        body.appendChild(tr);
      }

      const ft = document.createElement('tr'); ft.className = 'grand';
      ft.innerHTML = `<td><strong>Total</strong></td><td></td><td></td><td class="num"><strong>${files.length}</strong></td><td></td>`;
      foot.appendChild(ft);

      document.getElementById('kpi-right-title').textContent = 'Documents';
      document.getElementById('kpi-right-value').textContent = String(files.length);
      document.getElementById('kpi-right-sub').textContent   = `${type} â€¢ ${year}`;
    }
   
    // ===== render: documents (build folder list on the left, files on the right) =====
let __allDocs = [];
function renderDocuments(docs){
  __allDocs = Array.isArray(docs) ? docs : [];

  // Group by Type â†’ Year
  const byType = groupDocsByTypeYear(__allDocs);
  window.__docsByType = byType;

  // Build left â€œFoldersâ€ list from Types
  const types = Array.from(byType.keys()).sort((a,b)=> a.localeCompare(b));
  const folderItems = types.map(type => {
    const yearsMap = byType.get(type);
    const count = Array.from(yearsMap.values()).reduce((a,arr)=> a + arr.length, 0);
    return { key: type, label: type, count };
  });

  const firstType = folderItems[0]?.key || null;
  renderFolderList(folderItems, firstType);

  // KPI: total docs visible to user
  const total = __allDocs.length;
  document.getElementById('kpi-right-title').textContent = 'Documents';
  document.getElementById('kpi-right-value').textContent = String(total);
  document.getElementById('kpi-right-sub').textContent   = 'Total files';

  // Auto-show the newest year under the first type (if present)
  if (firstType){
    loadFolder(firstType);
  } else {
    document.getElementById('filesTitle').textContent = 'Select a folder';
    document.getElementById('crumbs').textContent = 'â€”';
    document.getElementById('filesBody').innerHTML = '';
    document.getElementById('filesFoot').innerHTML = '';
  }

  document.getElementById('docs-updated').textContent = 'Loaded ' + new Date().toLocaleString();
}
    // ===== render: interests =====
    function renderInterests(payload){
      const table = document.getElementById('interests-table');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      const tfoot = table.querySelector('tfoot');
      const updEl = document.getElementById('interests-updated');

      thead.innerHTML = ''; tbody.innerHTML = ''; tfoot.innerHTML = ''; updEl.textContent = '';
      if (!payload || !Array.isArray(payload.funds)) { setStatus('Unable to load interests.'); return; }

      const funds = (payload.funds || []).filter(f => (typeof f.interestFrac === 'number' ? f.interestFrac : 0) > 0);
      const memberBalanceOutstanding = Number(payload.currentBalance || 0);
      const moneyFmt = n => Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      if (!funds.length){
        tbody.innerHTML = `<tr><td class="sub">No positions found for your account.</td></tr>`;
        setCapitalCallsKpi(0, memberBalanceOutstanding);
        updEl.textContent = 'Loaded ' + new Date(payload.updated || Date.now()).toLocaleString();
        return;
      }

      // Header
      thead.innerHTML = `
        <tr>
          <th></th>
          ${funds.map(f => `<th class="num">${safe(f.fund)}</th>`).join('')}
          <th class="num">Total</th>
        </tr>`;

      function addRow(label, field, { moneyCells=false, sumTotal=false, bold=false, raw=false, format=null } = {}){
        const values = funds.map(f => {
          const vRaw = (typeof field === 'function') ? field(f) : f[field];
          if (raw) return safe(vRaw ?? 'â€”');
          if (moneyCells) {
            const base = `$${moneyFmt(Number(vRaw || 0))}`;
            return format ? format(base) : base;
          }
          return safe(vRaw ?? 'â€”');
        });

        let totalCell = 'â€”';
        if (sumTotal){
          const total = funds.reduce((a,f)=>{
            const vRaw = (typeof field === 'function') ? field(f) : f[field];
            return a + Number(vRaw || 0);
          }, 0);
          const baseTotal = `$${moneyFmt(total)}`;
          totalCell = format ? format(baseTotal) : baseTotal;
        }

        const tr = document.createElement('tr');
        if (label === 'Adjusted Total') tr.className = 'final-total';
        const cls = bold ? ' style="font-weight:700;"' : '';
        tr.innerHTML = `<td${cls}>${safe(label)}</td>${values.map(v => `<td class="num">${v}</td>`).join('')}<td class="num">${totalCell}</td>`;
        tbody.appendChild(tr);
      }

      // Rows
      addRow('Start',               f => f.startDate, { raw:true });
      addRow('Fund Size',           f => parseMoney(f.fundSize), { moneyCells:true, sumTotal:false });
      addRow('GP Commitment',       f => parseMoney(f.gpCommit), { moneyCells:true, sumTotal:false });
      addRow('Your interest in GP', f => f.interestPctDisplay,   { raw:true });
      addRow('Contributions (Employee)', 'employeeContrib', { moneyCells:true, sumTotal:true });
      addRow('Contributions (Employer)', 'employerContrib', { moneyCells:true, sumTotal:true });
      addRow('Subtotal',
            f => Number(f.employeeContrib||0) + Number(f.employerContrib||0),
            { moneyCells:true, sumTotal:true, bold:true });
      addRow('Distributions',
            f => Number(f.distributions || 0),
            { moneyCells:true, sumTotal:true, format: (val) => `(${val})` });
      addRow('Adjusted Total',
            f => (Number(f.employeeContrib||0) + Number(f.employerContrib||0)) - Number(f.distributions || 0),
            { moneyCells:true, sumTotal:true, bold:true });

      // KPI on the right
      const capitalCalls = funds.reduce((a,f)=> a + Number(f.employeeContrib||0) + Number(f.employerContrib||0), 0);
      setCapitalCallsKpi(capitalCalls, memberBalanceOutstanding);

      updEl.textContent = 'Loaded ' + new Date(payload.updated || Date.now()).toLocaleString();

      const signedAs = document.getElementById('signedAs');
      if (signedAs && payload.actingAs && payload.actingAs !== payload.email) {
        signedAs.textContent = `Acting as ${payload.actingAs} (admin: ${payload.email})`;
      }
    }

    async function loadInterests(){
      const [data, currBal] = await Promise.all([ apiPost('/api/list-interests', { ...adminBody() }, adminHeaders()), getCurrentBalance() ]);
      data.currentBalance = currBal; renderInterests(data);
    }

    // ===== current balance helper =====
    function computeGrandTotalFromTxRows(rows){
      return (rows || []).reduce((sum, r) => {
        const hasNet = r.Net_Amount != null && String(r.Net_Amount).trim() !== '';
        const netVal = hasNet ? parseMoney(r.Net_Amount) : (parseMoney(r.Credit) - parseMoney(r.Debit));
        const entity = r.EntityName || r.Entity || r.Entity_Name || '';
        if (excludedForTotals(entity)) return sum;
        return sum + netVal;
      }, 0);
    }
    async function getCurrentBalance(){
      if (typeof window.__currentBalance === 'number') return window.__currentBalance;
      try{ const txData = await apiPost('/api/get-portal-data', { ...adminBody() }, adminHeaders()); const gt = computeGrandTotalFromTxRows(txData.tx || []); window.__currentBalance = gt; return gt; }
      catch{ return 0; }
    }

    // ===== WIRE: helpers/render/load =====
    const norm = s => String(s||'').toLowerCase().replace(/[^a-z0-9]/g,'');
    function masked(val, visible=false){
      const s = String(val||'').replace(/\s/g,'').trim();
      if (!s) return '';
      if (visible) return String(val);
      const last4 = s.slice(-4);
      return 'â€¢'.repeat(Math.max(0, s.length - 4)) + last4;
    }
    function mkRow(label, raw, sensitive=false){
      const row = document.createElement('div'); row.className='rows';
      const l = document.createElement('div'); l.className='label'; l.textContent = label;
      const v = document.createElement('div'); v.className='value';
      const btns = document.createElement('div'); btns.className='buttons';
      let revealed = false;
      const render = ()=> v.textContent = sensitive ? masked(raw, revealed) : (raw || '');
      render();
      if (raw && String(raw).trim()){
        if (sensitive){
          const tog = document.createElement('button'); tog.className='btn'; tog.textContent='Reveal';
          tog.addEventListener('click', ()=>{ revealed = !revealed; tog.textContent = revealed ? 'Hide' : 'Reveal'; render(); });
          btns.appendChild(tog);
        }
      } else {
        v.innerHTML = '<span class="muted">â€”</span>';
      }
      row.appendChild(l); row.appendChild(v); row.appendChild(btns);
      return row;
    }
    async function loadWireRows(){
      const { wires, updated } = await apiPost('/api/list-wires', { ...adminBody() }, adminHeaders());
      return { wires: Array.isArray(wires) ? wires : [], updated };
    }
    function renderWireCards(wires, memberFunds, userEmail){
      const host = document.getElementById('wire-bankwrap');
      host.innerHTML = '';

      const byFund = new Map();
      for (const f of memberFunds) byFund.set(norm(f), true);
      const emailKey = norm(userEmail || '');

      const rows = (wires || []).filter(r => {
        const rowEmail = norm(r['Member_Email'] || '');
        const emailOk  = !rowEmail || (rowEmail === emailKey);

        const shortName = norm(r['Fund Short Name'] || '');
        const legalName = norm(r['Entity Legal Name'] || '');
        const fundOk = byFund.size === 0
          ? true
          : byFund.has(shortName) || byFund.has(legalName);

        return emailOk && fundOk;
      });

      if (!rows.length){
        const empty = document.createElement('div');
        empty.className = 'sub';
        empty.textContent = 'No wire instructions are available for your current holdings.';
        host.appendChild(empty);
        return;
      }

      const groups = new Map();
      for (const r of rows){
        const key = r['Fund Short Name'] || r['Entity Legal Name'] || 'Entity';
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(r);
      }

      for (const [title, list] of groups){
        for (const r of list){
          const card = document.createElement('div');
          card.className = 'bank-card';
          card.innerHTML = `<h4>${safe(title)}</h4>`;

          const wrap = document.createElement('div');
          wrap.className = 'rows-wrap';

          wrap.appendChild(mkRow('Entity Legal Name',   r['Entity Legal Name']));
          wrap.appendChild(mkRow('Fund Short Name',     r['Fund Short Name']));
          if (r['Interest'] != null && String(r['Interest']).trim() !== '') {
            wrap.appendChild(mkRow('Interest', r['Interest']));
          }
          wrap.appendChild(mkRow('Bank Name',                    r['Bank Name']));
          wrap.appendChild(mkRow('Bank Address',                 r['Bank Address']));
          wrap.appendChild(mkRow('Account Name',                 r['Entity Legal Name'] || r['Account Name']));
          wrap.appendChild(mkRow('Account Address',              r['Account Address']));
          wrap.appendChild(mkRow('Account Number',               r['Account Number'], true));
          wrap.appendChild(mkRow('Routing Number (WIRE)',        r['Routing Number (WIRE)'], true));
          wrap.appendChild(mkRow('Routing Number (ACH)',         r['Routing Number (ACH)'], true));
          wrap.appendChild(mkRow('SWIFT (international)',        r['SWIFT (international)']));
          wrap.appendChild(mkRow('Verbal confirmation - contact1', r['Verbal confirmation - contact1']));
          wrap.appendChild(mkRow('Verbal confirmation - contact2', r['Verbal confirmation - contact2']));

          card.appendChild(wrap);
          host.appendChild(card);
        }
      }
    }

    async function loadWire(){
      setStatus('Loadingâ€¦');
      const [{ funds, email, actingAs, updated: upd1 }, { wires, updated: upd2 }] = await Promise.all([
        apiPost('/api/list-interests', { ...adminBody() }, adminHeaders()),
        loadWireRows()
      ]);
      const memberFunds = (funds || [])
        .filter(f => (typeof f.interestFrac === 'number' ? f.interestFrac : 0) > 0)
        .map(f => f.fund || f.name || '');
      document.getElementById('kpi-right-title').textContent = 'Wire Scope';
      document.getElementById('kpi-right-value').textContent = memberFunds.length ? `${memberFunds.length}` : '0';
      document.getElementById('kpi-right-sub').textContent   = memberFunds.length ? 'Entities with interest > 0' : 'No active GP Interests found';
      renderWireCards(wires || [], memberFunds, actingAs || email);
      document.getElementById('wire-updated').textContent = 'Loaded ' + new Date(upd2 || upd1 || Date.now()).toLocaleString();
      if (actingAs && actingAs !== email){ document.getElementById('signedAs').textContent = `Acting as ${actingAs} (admin: ${email})`; }
      setStatus('');
    }

    // ===== data loaders =====
    async function loadTransactions(){ const data = await apiPost('/api/get-portal-data', { ...adminBody() }, adminHeaders()); renderTransactions(data); }
    async function loadDocuments(){
      const { docs } = await apiPost('/api/list-docs', { ...adminBody() }, adminHeaders());
      renderDocuments(docs || []);
    }

    // ===== downloads =====
    async function downloadDoc(fileId, el){
      try{
        if (el) { el.classList.add('disabled'); el.textContent = 'Preparingâ€¦'; }
        const { token } = await apiPost('/api/mint-doc', { fileId, ...adminBody() }, adminHeaders());
        location.href = `/api/dl?token=${encodeURIComponent(token)}`;
      }catch(e){ console.error(e); alert('Unable to download this file.'); }
      finally{
        if (el) { el.classList.remove('disabled'); el.textContent = 'Download'; }
      }
    }
    document.addEventListener('click', (e)=>{
      const dl = e.target.closest('.dl');
      if (dl && dl.hasAttribute('data-fid')){
        e.preventDefault();
        downloadDoc(dl.getAttribute('data-fid'), dl);
      }
    });

    // ===== router =====
    function setRoute(hash){
      const isDocs = (hash === '#/documents');
      const isInterests = (hash === '#/interests');
      const isWire = (hash === '#/wire');

      // show/hide cards
      document.getElementById('card-tx').classList.toggle('hidden', isDocs || isInterests || isWire);
      document.getElementById('card-docs').classList.toggle('hidden', !isDocs);
      document.getElementById('card-interests').classList.toggle('hidden', !isInterests);
      document.getElementById('card-wire').classList.toggle('hidden', !isWire);

      // sidebar
      document.getElementById('linkTx').classList.toggle('active', !(isDocs || isInterests || isWire));
      document.getElementById('linkDocs').classList.toggle('active', isDocs);
      document.getElementById('linkInterests').classList.toggle('active', isInterests);
      document.getElementById('linkWire').classList.toggle('active', isWire);

      // clear KPI right
      const kVal = document.getElementById('kpi-right-value');
      const kSub = document.getElementById('kpi-right-sub');
      if (kVal) kVal.textContent = '';
      if (kSub) kSub.innerHTML = '';

      if (isDocs) {
        document.getElementById('kpi-right-title').textContent = 'Documents';
        loadDocuments();
      } else if (isInterests) {
        document.getElementById('kpi-right-title').textContent = 'Capital Calls';
        loadInterests();
      } else if (isWire) {
        document.getElementById('kpi-right-title').textContent = 'Wire Scope';
        loadWire();
      } else {
        document.getElementById('kpi-right-title').textContent = 'Member Outstanding Balance';
        loadTransactions();
      }
    }

    window.addEventListener('hashchange', () => setRoute(location.hash));

    async function reloadActiveTab(){
      const isDocs = (location.hash === '#/documents');
      const isInterests = (location.hash === '#/interests');
      const isWire = (location.hash === '#/wire');
      const impState = document.getElementById('imp-state');

      try{
        if (isDocs)      await loadDocuments();
        else if (isInterests) await loadInterests();
        else if (isWire) await loadWire();
        else             await loadTransactions();

        setStatus('');
        if (impState) impState.textContent = (window.__admin?.actAs ? 'Impersonation ON' : 'Impersonation OFF');
      }catch(e){
        console.error(e);
        const msg = (e && e.message) ? e.message : 'Unknown error';
        setStatus(`Error loading ${isDocs ? 'documents' : isInterests ? 'interests' : isWire ? 'wire instructions' : 'transactions'}: ${msg}`);
        if (impState) impState.textContent = `Error: ${msg}`;
        await new Promise(r => setTimeout(r, 400));
        if (isDocs)      await loadDocuments();
        else if (isInterests) await loadInterests();
        else if (isWire) await loadWire();
        else             await loadTransactions();
      }
    }

    // ===== GIS init =====
    function initGis(){
      if(!window.google || !google.accounts || !google.accounts.id){ setTimeout(initGis,50); return; }
      google.accounts.id.initialize({
        client_id: WEB_CLIENT_ID,
        callback: ({credential}) => afterSignIn(credential),
        auto_select: true,
        use_fedcm_for_prompt: true,
        cancel_on_tap_outside: false
      });
      const btnHost = document.getElementById('g_id_signin');
      if (btnHost) google.accounts.id.renderButton(btnHost, { theme:'outline', size:'large' });
      google.accounts.id.prompt();
    }

    // ===== after sign-in =====
    async function afterSignIn(credential){
      try{
        const r = await fetch('/api/session', {
          method:'POST',
          headers:{'content-type':'application/json'},
          credentials:'include',
          cache:'no-store',
          body: JSON.stringify({ credential })
        });
        if(!r.ok) throw new Error('session create failed');

        const { user } = await waitForSession(5000);
        if (user?.email){
          document.getElementById('signedAs').textContent = `Signed in as ${user.email}`;
          document.getElementById('kpi-name').textContent  = user.name || 'â€”';
          document.getElementById('kpi-email').textContent = user.email || 'â€”';
        }
        if (!location.hash) location.replace('#/transactions');
        await reloadActiveTab();

        // optional warm
        Promise.resolve().then(()=>{
          loadDocuments().catch(()=>{});
          loadTransactions().catch(()=>{});
          loadInterests().catch(()=>{});
        });
      }catch(e){ console.error(e); setStatus('Sign-in failed. Please try again.'); }
    }

    // ===== impersonation (TOPBAR) =====
    (function(){
      const panel = document.getElementById('imp-panel');
      const toggle= document.getElementById('imp-toggle');
      const startB= document.getElementById('imp-start');
      const stopB = document.getElementById('imp-stop');
      const state = document.getElementById('imp-state');
      const iEmail= document.getElementById('imp-email');
      const iReason=document.getElementById('imp-reason');
      const iToken =document.getElementById('imp-token');

      toggle.addEventListener('click', ()=> panel.classList.toggle('hidden'));
      document.addEventListener('click', (e)=>{
        if (!panel.classList.contains('hidden')){
          const within = e.target.closest('#imp-panel') || e.target.closest('#imp-toggle');
          if (!within) panel.classList.add('hidden');
        }
      });

      async function applyImpersonationUI(){
        const signedAs = document.getElementById('signedAs');
        if (window.__admin?.actAs && window.__admin?.token){
          signedAs.textContent = `Acting as ${window.__admin.actAs} (admin: ${document.getElementById('kpi-email').textContent || 'you'})`;
          state.textContent = 'Impersonation ON';
        } else {
          try{
            const r = await me();
            if (r.ok){
              const info = await r.json();
              if (info?.user?.email) {
                signedAs.textContent = `Signed in as ${info.user.email}`;
              } else {
                signedAs.textContent = 'Signed out';
              }
            }
          } catch {
            signedAs.textContent = 'Signed out';
          }
          state.textContent = 'Impersonation OFF';
        }
      }
      async function startImpersonation(){
        window.__admin.actAs  = (iEmail.value || '').trim();
        window.__admin.reason = (iReason.value || '').trim();
        window.__admin.token  = (iToken.value || '').trim(); // simple admin token (e.g., "page mill")
        if (!window.__admin.actAs || !window.__admin.token){
          state.textContent = 'Email and token required';
          return;
        }
        panel.classList.add('hidden');
        await reloadActiveTab();
        await applyImpersonationUI();
      }

      async function stopImpersonation(){
        window.__admin.actAs = null;
        window.__admin.reason = '';
        window.__admin.token = null;
        iEmail.value = '';
        iReason.value = '';
        iToken.value = '';
        panel.classList.add('hidden');
        await reloadActiveTab();
        await applyImpersonationUI();
      }

      startB.addEventListener('click', startImpersonation);
      stopB .addEventListener('click', stopImpersonation);

      // initialize the topbar state on load
      applyImpersonationUI();
    })();

    // ===== simple nav helpers =====
    document.getElementById('linkTx')       ?.addEventListener('click', () => location.hash = '#/transactions');
    document.getElementById('linkDocs')     ?.addEventListener('click', () => location.hash = '#/documents');
    document.getElementById('linkInterests')?.addEventListener('click', () => location.hash = '#/interests');
    document.getElementById('linkWire')     ?.addEventListener('click', () => location.hash = '#/wire');

    // ===== boot =====
    (function boot(){
      const tag = document.getElementById('buildTag');
      if (tag){
        const now = new Date();
        tag.textContent = `Build: ${now.toLocaleString()}`;
      }
      if (!location.hash) location.replace('#/transactions');
      setRoute(location.hash);
      initGis();
    })();
  </script>
</body>
</html>





