<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
  async function listDocs(idToken) {
    const r = await fetch('/api/list-docs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken })
    });
    const j = await r.json();
    if (!r.ok || !j.ok) throw new Error(j.error || 'list-docs failed');
    return j.docs || [];
  }

  async function mintToken(idToken, fileId) {
    const r = await fetch('/api/mint-doc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ idToken, fileId })
    });
    const j = await r.json();
    if (!r.ok || !j.ok) throw new Error(j.error || 'mint failed');
    return j.token;
  }

  function renderDocs(rows) {
    const tbody = document.getElementById('tbody');
    const tbl = document.getElementById('docsTable');
    const empty = document.getElementById('empty');
    if (!rows.length) { tbl.style.display='none'; empty.style.display=''; tbody.innerHTML=''; return; }
    tbl.style.display=''; empty.style.display='none';
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${esc(r.Doc_Title || '')}</td>
        <td>${esc(r.Member_Name || '')}</td>
        <td>${fmtDate(r.ModifiedTime)}</td>
        <td>${fmtSize(r.SizeBytes)}</td>
        <td><button onclick="onDownload('${encodeURIComponent(r.GoogleFileID)}', this)">Download</button></td>
      </tr>`).join('');
  }

  async function onDownload(fileId, btn) {
    try {
      const token = await mintToken(window.__idToken, decodeURIComponent(fileId));
      window.location.href = `/api/dl?token=${encodeURIComponent(token)}`;
    } catch (e) {
      console.error(e); alert('Unable to download.');
    }
  }

  // GIS init
  window.onload = function () {
    google.accounts.id.initialize({
      client_id: '468716163323-st1b43fu76emqlj1cde6mmq770sbeno1.apps.googleusercontent.com',
      callback: async (resp) => {
        window.__idToken = resp.credential;
        document.getElementById('status').textContent = 'Signed in. Loading documentsâ€¦';
        try {
          const docs = await listDocs(resp.credential);
          renderDocs(docs);
          document.getElementById('status').textContent = 'Ready.';
        } catch (e) {
          console.error(e);
          document.getElementById('status').textContent = 'Failed to load documents.';
        }
      }
    });
    google.accounts.id.renderButton(document.getElementById('g_id_signin'), { theme: 'outline', size: 'large' });
  };

  // utils
  function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function fmtDate(iso){ if(!iso) return ''; const d=new Date(iso); return isNaN(d)?'':d.toLocaleString(); }
  function fmtSize(bytes){ const n=Number(bytes||0); if(!isFinite(n)||n<=0) return ''; const u=['B','KB','MB','GB']; let i=0,x=n; while(x>=1024&&i<u.length-1){x/=1024;i++;} return `${x.toFixed(i?1:0)} ${u[i]}`; }
</script>
